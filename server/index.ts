import { fastify, FastifyServerOptions } from 'fastify'
import fastifyStatic, { FastifyStaticOptions } from '@fastify/static'

import path from './path.js'

const fastifyOptions: FastifyServerOptions = {
  logger: {
    transport: {
      target: 'pino-pretty',
      options: { destination: 1 },
    },
  },
}
const staticOptions: FastifyStaticOptions = {
  root: path.publicPath,
}

const server = fastify(fastifyOptions)

server.register(fastifyStatic, staticOptions)

server.get('/', async (request, reply) => {
  setImmediate(() => {
    reply.sendFile('index.html')
  })
  // return reply is needed to tell Fastify we will call
  // reply.send() in the future.
  return reply
})

server.get('/unsafe-cookie', async (request, reply) => {
  setImmediate(() => {
    reply
      .header('set-cookie', `unsafeSessionId=unsafe${Date.now()}; Max-Age=3600; Same-site=Lax`)
      .send('')
  })
  // return reply is needed to tell Fastify we will call
  // reply.send() in the future.
  return reply
})

server.get('/safe-cookie', async (request, reply) => {
  setImmediate(() => {
    reply
      .header(
        'set-cookie',
        `safeSessionId=safe${Date.now()}; HttpOnly; Max-Age=3600; Same-site=Lax`
      )
      .send('')
  })
  // return reply is needed to tell Fastify we will call
  // reply.send() in the future.
  return reply
})

const start = async () => {
  try {
    await server.listen({ port: 3000 })
  } catch (err) {
    server.log.error(err)
    process.exit(1)
  }
}
start()
