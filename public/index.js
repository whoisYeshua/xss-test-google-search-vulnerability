import { purify } from './purify/index.js'

const unsafeForm = document.querySelector('.unsafe__form')
const unsafeOutput = document.querySelector('.unsafe__output')

const supersafeForm = document.querySelector('.supersafe__form')
const supersafeOutput = document.querySelector('.supersafe__output')

const semisafeForm = document.querySelector('.semisafe__form')
const semisafeOutput = document.querySelector('.semisafe__output')

const safeForm = document.querySelector('.safe__form')
const safeOutput = document.querySelector('.safe__output')

const unsafeInsert = (target, value = '') => {
  target.innerHTML = value
}

const supersafeInsert = (target, value = '') => {
  target.textContent = value
}

const semisafeInsert = (target, value = '') => {
  const template = document.createElement('template')
  template.innerHTML = value
  purify(template.content)

  target.innerHTML = template.innerHTML
}

const safeInsert = (target, value = '') => {
  const template = document.createElement('template')
  template.innerHTML = value
  purify(template.content)

  const serializedNewTree = new XMLSerializer().serializeToString(template)
  // Remove the outer span before returning the string representation of the
  // processed copy.
  const serializedValue = serializedNewTree.slice(
    serializedNewTree.indexOf('>') + 1,
    serializedNewTree.lastIndexOf('</')
  )
  target.innerHTML = serializedValue
}

const submitHandler = (callback, target) => event => {
  event.preventDefault()
  let form = new FormData(event.target)
  const inputValue = form.get('input')
  callback(target, inputValue)
}

unsafeForm.addEventListener('submit', submitHandler(unsafeInsert, unsafeOutput))
supersafeForm.addEventListener('submit', submitHandler(supersafeInsert, supersafeOutput))
semisafeForm.addEventListener('submit', submitHandler(semisafeInsert, semisafeOutput))
safeForm.addEventListener('submit', submitHandler(safeInsert, safeOutput))
